# ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆæ‰‹æ³•è¬›åº§

å‚è€ƒè³‡æ–™ï¼š
https://zenn.dev/yamachan0625/books/ddd-hands-on/viewer/chapter1_intro

## ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã¨ã¯
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŒè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ç‰¹å®šã®å•é¡Œé ˜åŸŸã‚’æŒ‡ã—ã¾ã™ã€‚

## æˆ¦è¡“çš„è¨­è¨ˆ
![alt text](https://storage.googleapis.com/zenn-user-upload/0852995fe722-20240108.png)

|ãƒ¬ã‚¤ãƒ¤ãƒ¼|èª¬æ˜|
|-|-|
|ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤|ã“ã‚Œã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ã‚¢ã§ã‚ã‚Šã€ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ä¸»ã«ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã€ãŠã‚ˆã³ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ãŒå«ã¾ã‚Œã¾ã™ã€‚|
|ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤|ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’çµ„ã¿ç«‹ã¦ã‚‹ãŸã‚ã«ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¸»ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãŒå«ã¾ã‚Œã¾ã™ã€‚|
|ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤|ã“ã®å±¤ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¿…è¦ãªå¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹) ã¸ã®é€šä¿¡ã‚’æ‹…å½“ã—ã¾ã™ã€‚ä¸»ã«ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ãŒå«ã¾ã‚Œã¾ã™ã€‚|
|ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤|ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€é©åˆ‡ãªå¿œç­”ã‚’è¿”ã—ã¾ã™ã€‚ä¸»ã« Web UIã€REST APIã€CLI ãªã©ãŒå«ã¾ã‚Œã¾ã™ã€‚|

## ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ (DIPï¼‰
ã‚ªãƒ‹ã‚ªãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã‘ã‚‹ä¾å­˜é–¢ä¿‚ã®æ–¹å‘æ€§ã¯ã€ã€Œä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ (Dependency Inversion Principle, DIP) ã€ã¨ã„ã†ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¨­è¨ˆã®åŸå‰‡ã‚’åæ˜ ã—ã¦ã„ã¾ã™ã€‚ã“ã®åŸå‰‡ã¯ä»¥ä¸‹ã®äºŒã¤ã®ãƒã‚¤ãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

* **ä¸Šä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä¸‹ä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã—ã¦ã¯ãªã‚‰ãªã„ã€‚**

    ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€ä¸Šä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤) ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚„å¤–éƒ¨ API ã®ã‚ˆã†ãªä¸‹ä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ã‚„ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤) ã«ä¾å­˜ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€ã€‚ãã—ã¦ã€ã©ã¡ã‚‰ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚‚æŠ½è±¡ã«ä¾å­˜ã™ã¹ãã§ã™ã€‚

    ä¾‹ãˆã°ã€ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå…¥ã£ã¦ã„ã‚‹ã¨ã€ã©ã¡ã‚‰ã‹ã‚’å¤‰æ›´ã—ãŸéš›ã«ã‚‚ã†ä¸€æ–¹ã«å½±éŸ¿ãŒå‡ºã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã¯ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ã«åã—ã¦ã„ã¾ã™ã€‚

    ```python
    # ã“ã‚Œã¯ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ã«åã—ã¦ã„ã‚‹
    def sayHello(name: str) -> None:
        logger(f'Hello {name}!')

    sayHello('World')
    ```

    ```python
    # ã“ã‚Œã¯ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹
    def sayHello(name: str, logger: function) -> None:
        logger(f'Hello {name}!')

    sayHello('World', print)
    ```

* **æŠ½è±¡ã¯è©³ç´°ã«ä¾å­˜ã—ã¦ã¯ãªã‚‰ãªã„ã€‚è©³ç´°ãŒæŠ½è±¡ã«ä¾å­˜ã™ã¹ãã§ã‚ã‚‹ã€‚**

    æŠ½è±¡ (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã‚„æŠ½è±¡ã‚¯ãƒ©ã‚¹) ã¯è©³ç´° (å…·ä½“çš„ãªå®Ÿè£…) ã«ä¾å­˜ã›ãšã€è©³ç´°ã¯æŠ½è±¡ã«ä¾å­˜ã™ã¹ãã§ã™ã€‚


## éšå±¤æ§‹é€ 
```
â”œâ”€â”€ å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã¨æ¥ç¶šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
â”œâ”€â”€ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
â””â”€â”€ APIã®é–¢æ•°å†…å‡¦ç†ãƒ»UIå†…ã®å‡¦ç†ãªã©
    â””â”€â”€ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
        â”œâ”€â”€ ã‚µãƒ¼ãƒ“ã‚¹
        â””â”€â”€ ãƒ¬ãƒã‚¸ãƒˆãƒª
            â””â”€â”€ ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
                â””â”€â”€ å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
```

## ãã‚Œãã‚Œã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
### å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
```python
class ID:
    # [!]å€¤ã®å‹ã‚’å®šç¾©ã—ã¦ã‚„ã‚‹ã“ã¨
    _value: int

    def __init__(self, value: int) -> None:
        self._value = varidate(value)

    # [!]å—ã‘å–ã£ãŸå€¤ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‹ã‚‰ä¿æŒã™ã‚‹
    def varidate(value: int) -> int:
        if not isinstance(value, int):
            raise ValueError('å€¤ãŒintã§ã¯ã‚ã‚Šã¾ã›ã‚“')
        if value < 0:
            raise ValueError('å€¤ãŒ0æœªæº€ã§ã™')
        
        # ...

        return value

    # [!]ã‚¯ãƒ©ã‚¹ãŒä¿æŒã—ã¦ã‚‹å¤‰æ•°ã‚’å–ã‚Šå‡ºã—ãŸã„å ´åˆã¯ã€å¤‰æ•°ã‚’ç›´æ¥å©ã‹ãšã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä»‹ã—ã¦å–ã‚Šå‡ºã™
    def value(self) -> int: ## ã“ã†ã„ã†å½¹å‰²ã®ãƒ¡ã‚½ãƒƒãƒ‰ã®ã“ã¨ã‚’getterã¨ã„ã†
        return self._value
```

```python
id = ID(1)

print(id.value()) # 1

# [!]å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯çµ¶å¯¾ã«ä¿æŒã—ã¦ã‚‹å€¤ã‚’ä¸Šæ›¸ãã—ã¦ã¯ã„ã‘ãªã„
id._value = 2

error_id = ID(-1) # ValueError: å€¤ãŒ0æœªæº€ã§ã™
```


### ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å±æ€§ã«è¿‘ã„ã‚‚ã®
|id|name|age|
|-|-|-|
|1|Alice|20|
|2|Bob|30|
|3|Charlie|40|
|...|...|...|

â†‘ã“ã†ã„ã†æ„Ÿã˜ã®DBã‚’æƒ³åƒã—ã¦ã„ã‚‹å ´åˆã€
å¿…è¦ãªå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å…¨éƒ¨å®šç¾©ã—ã¦ã‚ã’ãŸä¸Šã§ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã™ã‚‹

```python
from .value_object import ID, Name, Age

# [!]å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã£ã¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©ã™ã‚‹
class UserEntity:
    _id: ID
    name: Name
    age: Age

    def __init__(self, id: ID, name: Name, age: Age):
        self._id = id
        self.name = name
        self.age = age

    # [!]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒæŒã£ã¦ã‚‹å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–ã‚Šå‡ºã™ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä»‹ã—ã¦å–ã‚Šå‡ºã™
    # [!]å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¿æŒã™ã‚‹å€¤ã‚’ç›´æ¥å–ã‚Šå‡ºã™ã“ã¨ã¯ã—ãªã„
    def id(self) -> ID:
        return self._id

    def name(self) -> Name:
        return self.name

    def age(self) -> Age:
        return self.age


    # [!]ãƒªã‚¹ãƒˆã€ã‚¿ãƒ—ãƒ«ã€JSONã€è¾æ›¸ã§è¿”ã™å ´åˆã§ã‚‚åŒæ§˜
    def toDict(self) -> dict:
        return {
            'id': self._id,
            'name': self.name,
            'age': self.age
        }
```

```python
user = UserEntity(ID(1), Name('Alice'), Age(20))

print(user.id()) # ID(1)
print(user.name()) # Name('Alice')
print(user.age()) # Age(20)

# [!]ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’åŒºåˆ¥ã™ã‚‹å€¤ä»¥å¤–ã¯ä¸Šæ›¸ãã§ãã‚‹
user.name = Name('Bob')
user._id = ID(2) # ã“ã‚Œã¯ãƒ€ãƒ¡

```

### ãƒªãƒã‚¸ãƒˆãƒª
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ“ä½œã«è¿‘ã„ã‚‚ã®
* CRUDæ“ä½œ
    * `Create`ï¼šæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹
    * `Read`ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    * `Update`ï¼šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹
    * `Delete`ï¼šãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹

```python
class UserRepository:
    # [!]ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å—ã‘å–ã‚‹
    def __init__(self, db_client):
        self.client = db_client

    # [!]CRUDæ“ä½œã‚’å®šç¾©ã™ã‚‹
    # [!]ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ™ãƒ«ã®æ“ä½œã¯ã‚„ã£ã¡ã‚ƒãƒ€ãƒ¡ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«åã®å¤‰æ›´ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªã‚»ãƒƒãƒˆã€åˆ—è¿½åŠ ï¼‰â†’ ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã‚„ã‚‹
    def create(self, user: UserEntity) -> None:
        try:
            self.client.execute(
                'INSERT INTO users (id, name, age) VALUES (?, ?, ?)',
                (
                    user.id().value(), 
                    user.name().value(), 
                    user.age().value()
                )
            )
        except Exception as e:
            raise Exception('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸï½±ï½¾ï½±ï½¾ğŸ‘‰ğŸ‘ˆğŸ’¦')
        else:
            self.client.commit()


    def selectAll(self) -> list:
        try:
            self.client.execute('SELECT * FROM users')
            users = self.client.fetchall()
        except Exception as e:
            raise Exception('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸï½±ï½¾ï½±ï½¾ğŸ‘‰ğŸ‘ˆğŸ’¦')
        else:
            return users


```


```python
# DBã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸
db_client = sqlite3.connect('example.db').cursor()
db_client.execute(
    'CREATE TABLE users (id int, name text, age int)'
)

# [!]ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ¸¡ã—ã¦ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹
repository = UserRepository(db_client)
repository.create(
    UserEntity(ID(1), Name('Alice'), Age(20)
)
```


### ã‚µãƒ¼ãƒ“ã‚¹
* å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ãƒªãƒã‚¸ãƒˆãƒªã§ç¦æ­¢ã—ã¦ã„ãŸã“ã¨ã‚’ã‚„ã‚‹å ´
* å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    * é‡è¤‡ãƒã‚§ãƒƒã‚¯ ... ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸­èº«ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    * ãƒãƒƒã‚·ãƒ¥åŒ– ... ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹
* ãƒ¬ãƒã‚¸ãƒˆãƒª
    * ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ™ãƒ«ã®æ“ä½œ ... ãƒ†ãƒ¼ãƒ–ãƒ«åã®å¤‰æ›´ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªã‚»ãƒƒãƒˆã€åˆ—è¿½åŠ 


```python

# ä¾‹ãˆã°åå‰ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã‚µãƒ¼ãƒ“ã‚¹
class CheckDuplicateNameService:
    # [!] åŸºæœ¬ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¯execute()ã«ã™ã‚‹ã€å¼•æ•°ã¯ãªã—
    def __init__(self, db_client, name_obj: Name):
        self.client = db_client
        self.name = name_obj

    def execute(self):
        try:
            self.client.execute(
                'SELECT * FROM users WHERE name = ?',
                (self.name.value(),)
            )
            user = self.client.fetchone()

            if user:
                raise ValueError('åå‰ãŒé‡è¤‡ã—ã¦ã„ã¾ã™')
            
        except Exception as e:
            raise Exception('åå‰ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸï½±ï½¾ï½±ï½¾ğŸ‘‰ğŸ‘ˆğŸ’¦')
        else:
            return self.name
```